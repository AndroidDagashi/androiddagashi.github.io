name: Update Json files
on:
  schedule:
    - cron: '0 * * * *'

jobs:
  push_json_and_rssfeed:
    if: github.event.event_name == 'schedule' || (github.event.event_name == 'issue_comment' && github.event.issue.number == 78)
    name: Update Json files
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PUSH_ACCESS_TOKEN: ${{ secrets.PUSH_ACCESS_TOKEN }}
      GH_READONLY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      PROJECT_USER_NAME: AndroidDagashi
      PROJECT_REPO_NAME: androiddagashi.github.io

    steps:
    - uses: actions/checkout@v1
      with:
        ref: development

    - uses: actions/setup-node@v1
      with:
        node-version: '10.16.0'

    - name: Setup git config
      run: sh ./.github/setup-git-config.sh

    # https://github.com/actions/cache/issues/63
    # - name: Restore cache
    #   id: restore-cache
    #   uses: actions/cache@v1
    #   with:
    #     path: node_modules
    #     key: yarn-deps-${{ hashFiles('yarn.lock') }}
    #     restore-keys: |
    #       yarn-deps-

    - name: yarn install
      # if: steps.cache-primes.outputs.cache-hit != 'true'
      run: yarn install

    - name: Generate json resources
      run: yarn generateJson

    - name: Generate RSS feed
      run: yarn generateRssFeed

    - name: Push generated files if there's any update
      run: sh ./.github/push-resources-if-updated.sh

    - name: Print debug info
      if: failure()
      run: |
        git remote
        git status
